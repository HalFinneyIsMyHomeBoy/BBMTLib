#!/bin/bash

set -e  # Exit on error
set -o pipefail  # Catch errors in pipes

BIN_NAME="bbmt"
BUILD_DIR="./bin"

# Ensure build directory exists
mkdir -p "$BUILD_DIR"

# Build the Go binary
echo "Building the Go binary..."
go build -o "$BUILD_DIR/$BIN_NAME" ../cli/main.go

# Array to store all keygen process PIDs
PIDS=()

NOSTR_RELAY=ws://localhost:7777

NSEC1=nsec18jnh37qs39mtpgzc4w6rckdtndt7jd36rhapqwalhfqke3dh8u3qgyyz8z
NPUB1=npub1ry0n9qvavgveanjr25meq46hf57axt4qhnvgfl68sn5haddyf6wqpr79uv
PPM1='{"PaillierSK":{"N":26559735838229302912282332119695933684236488433042895405637808122131391715540619594107633230020203704186290432335444748383590822320324844311113324107194818855415792809328869636585916785198144899804277255042138324439163767516348626366848798744617547274607315154702679784592748724190502826275714257218677013460303955013309266442578617737671395457417456174149838724587844765760811557544716172717201112290357095671474849773901320830153197991080525833453357251832994791476013145255067277448523284046911400927080120164232403217407405736971691663558617583514548586217007720127825504244390697625657129889420299706039014230097,"LambdaN":13279867919114651456141166059847966842118244216521447702818904061065695857770309797053816615010101852093145216167722374191795411160162422155556662053597409427707896404664434818292958392599072449902138627521069162219581883758174313183424399372308773637303657577351339892296374362095251413137857128609338506729988677699444430863088232421339677560110389984490979632054916733063130570819266151243810059297691682665264044658981012512944597972157047250609651261523784286879471783162738156271048288842089889080394413008484338660747498795448732166411567382014387202421326401146940569383885876252637315465130781666075752982578,"PhiN":26559735838229302912282332119695933684236488433042895405637808122131391715540619594107633230020203704186290432335444748383590822320324844311113324107194818855415792809328869636585916785198144899804277255042138324439163767516348626366848798744617547274607315154702679784592748724190502826275714257218677013459977355398888861726176464842679355120220779968981959264109833466126261141638532302487620118595383365330528089317962025025889195944314094501219302523047568573758943566325476312542096577684179778160788826016968677321494997590897464332823134764028774404842652802293881138767771752505274630930261563332151505965156,"P":173648294861060099948647924251062910980644451876318300466504247509701897820817161101641710701398181286064151216211310069666644810728957841266149470159597449444645250015696788625755027558625681628381343564667021847523611167606117114018638161617320910762040925872566999225701661587910380922214953039302100685559,"Q":152951319559344616453504970740977426216031753291561160011507052124848518085366709127939282993575549054882609239727985734597357236037473490967905258625828768272424328913894176280671678804105941137909950582596704048388796978468110216716844657868453270612313991961377366250917283532472118036943783334585407579383},"NTildei":25025685163686309115325039800430524975054140424714318738366990487011743161887998026127051321113407070395037876065857241156564682289525288619440547227419888813092628686063893579560498258875386476371816352834204146304853186016383310131607253283275684285769512406842027188545333869156950603827862312249427842358966245651094759356221692027031087151519624158821369205039772975023678704352640909745484484725955691499933922261477815944344495263319967617271033826570463960137902285965596979118316361728930717793115002830898205738682420462397095764737480344184264742838754372879261159681535498087303631775251572431452201098521,"H1i":10394287921604821988836717836610989070590914688685776657460253787029355024965513376033934120051253513939019584368986791461269625713789799995291583561735475541669313842951907254028759109023102842357592870833499234679494708495174321239009804636508292918075258240432858067638022475973196946979460160636726468247317153453290099654614379069548824268182194324825844895291267659899730198423781696433972348234122681447935003970612681616906570148651136176044517338535010710784758205113001125368820725366753990658486180620262195766627540916532004850133636259580778068138725040040024278226847434243940256702674779460956699835524,"H2i":4039464370537679847483778314252783013647699076310897876380854016814409249346843709598967837044344236410495477114802800472619067757350273899026289945774062985241248250204876158605445934069337125340664897333745761852629957146333366544550585414707828055737283009763194163368516501455268214956385525007709468693437907375913689973842422475018951066259009269695123577427269112128201668418521176594109516784197918934085079372357059995840813164660884520773863127472111020595716698098477297842946476754076716096214834827433317635341446139217599392065489116128251825147138166297485410209597377322347985132039480144066290741670,"Alpha":22371687223519478194888417702303519898124533405429313830540368174176080121545348559673669909633696490696634245864442951599146640305523659790653407521502399409778246043388713484306671948976958340440119888280654104008241463849552462054437114512445287913736663778877584759440204928298687129813749229878761519188601462660472657121437095588080950192649791064701307904441949256447333581343796842484381678666726952024767422945936995627439764019500528691328665029421507552908041594770098900681230061498885139610439578427682521364445176987872115329965197510545630221550057788040003727501967118974223858369742896978712014853200,"Beta":754555310824578737769865700459724138473278932937798179136897828410613954884937447567848484325125780748187920117105148009374409560899891795868463169396289668563147304172160464307377296507499352360030861155648852774728235228045482452163229970275550269649952240895811050575152622125614909293307818040333668650743610863323362352450785029288343029041360554848391131058665386594875502652533708247111578919087272738435309082928947123362995033572052658578269681583507081404668116195757126694335810619226961506205574214665108331129028419660283788866190776943661885761981614169313648788121791026811094877241706661736069278158,"P":88606403202162442845112203925965821852081308353788856076833917266072025111396251688513386652220298383012276982806756403776454311810148331552953255480203258224845731445288429200988753922213307300419221855084096147438871572907156778263818224281356130244395137783294222485951762635646518040590115973370679492899,"Q":70609132803270013163126017687516341677349659473861743527726364021779221277295806764846021972469901731984631041062321711582758506464517218240172424254383148562112325686636195278053986937628411308065222050597071546636372795019300466055527563016040141138776546309937373261511811729449476139925041901365316229839}'

NSEC2=nsec1qucmxuagznf33744e6xfy6yxt3g7rfcv4pecr42aswmzynfvdl9quu7v2m
NPUB2=npub1vj4gakv4epy2yzxd4ck0hnejwyuefzedlylrqswmnfktc4gsl3zsplxuth
PPM2='{"PaillierSK":{"N":25392098524471745520483771802460598230585497674179236861344474126463119534810679655308660523365701065483252668149138309107170298260067792589212780715677427426421244263033658142577949014624980584800539666352651198328827262567517278266339682204355849054090757507999119730854015490639684854136007604085570052822856822694432220924811787853423501346181988548930995864397655863684745350794988569403191559291498947037740693608179633382470548150117180306720505090789473385406834289232317712431628785417285811087039660805806943103947904368447397352456364295483167326220757729380760991174182171245751090291877442492415702234397,"LambdaN":12696049262235872760241885901230299115292748837089618430672237063231559767405339827654330261682850532741626334074569154553585149130033896294606390357838713713210622131516829071288974507312490292400269833176325599164413631283758639133169841102177924527045378753999559865427007745319842427068003802042785026411268003633828745496905985761307647484057665332073096970247942408500445163084225148274078771693075885222175477833880417352137814094069911491796478252843730121231556884815398766603604803849878050634797974878844863248796052826358121091037395278679624059218866440546283400851700296122148557100545971233401013383758,"PhiN":25392098524471745520483771802460598230585497674179236861344474126463119534810679655308660523365701065483252668149138309107170298260067792589212780715677427426421244263033658142577949014624980584800539666352651198328827262567517278266339682204355849054090757507999119730854015490639684854136007604085570052822536007267657490993811971522615294968115330664146193940495884817000890326168450296548157543386151770444350955667760834704275628188139822983592956505687460242463113769630797533207209607699756101269595949757689726497592105652716242182074790557359248118437732881092566801703400592244297114201091942466802026767516,"P":178807060921755418822056748650802323903568679812043277824947355446844572501661362189971432491925427353322486496646723000408397668965414244572912674583237164736457625071249709499246541919178064735266172687347666919269883935203006032880815965689745423308843715983235690183393151237672544513413537235875566948363,"Q":142008365852974512177759582157404054163089204972758646076823691237010452124876910665062583413421749240067251443772075677786522293011943078554635910518775978207262894530270469725172635798351645082177538360769549687085914780528149137500757772434173784474181132304958499287388427763781431577371962789738108518519},"NTildei":25225238975772475784491515995385276823781525064746428674869963815658090094943473395305720809753750517864287361983906228360565748228661917263955626016096592498865534212375525664532277515743317410833322394431189330923155862695386972550036710756079846372396849596343678933733117846024735574625591251784185644929468780202376521876496528305146730464182075093359743932099880056505641779261198093288877228283409713641481958907975872931814317468396767311700773536744852060945779448001727769009986732679214709599566300140594751419042919673171241264341797939633923485989468838529914695496594024212939929712922555574098296285293,"H1i":6298315488992455371752323555630151966346380542010196738460082119766978031544945985174139476570639996769444326746067501050043234040261369453178874209279127978056767726286082055051800524438507395088291422341025296742686515838981594544701311054826971344935518188404738502969798847629504190829906339269006998698403214964601145487053666634957275877765424407468662719505966373177790674678842321405865484870708766667013129207207670263236464246680536005163567510033104978339711372251892254136681295733294284901837966701324131701767970010514424726571467955016963204621160704257419190510414040258700738492299691546412291929793,"H2i":23288127199788866534723212889864251456605447425783061915981408945333012507983114504745885388640835763667517492780223183495749205930721402491535131329507506293634886153076639781488903466459223008505462513574532502665601349155453926357537562666592312648049512107709702193843297001659939358319037025025155774752282087453807615654687820048881008565998151392436975114924719049437150949288281116334280322406175898692204877584378600407082588581115137223840010262751470035050928638184834508587304261144312292740564492941948917821416150113983104560082783808578975671465875031691929617898776777381563341842075201505584102188800,"Alpha":21430608870326062931370156626930138176997596297990135418734143219235245617712834811282219275237591311307593874894705418806754842803966060490022166816943681012847202759000943919917908342937645121043083103327165736779377215553455428973790912433404095823791710290095288824859914549808008984773499238751478862495718754509860917458946066707214322512227215818723784917654521777230990980039896432727663596412142159531067403779811515823003629642004283918243092389473274026316270952891537672721289925596745791016281238392144837851529461138980663582356709025415630865680534748244151199913176576636099114817183151805326230141138,"Beta":1782569944181734860841728613930873476202211310726672412304165761950364324585936742681748965407883481970126455545426301015727811501529726020375840728287716376925839690035163109966392857440655883197904405121310557718018700291514885604524715510980030673500967144226622202644045936565387150717509104143692182308312974791266784420009526305128646646873287963525369817476572938595271141686138697687879359736075649562359951008921613268995849328251667796645297537731467095071546189399426657750962988029388179962883728482106188827477193347634618273581521269913959754999399173432251971681338701180670775498849376657499896433745,"P":86855755148807865026453045541547485173237421264421826005564131052470053190293847614931720661001783387709694931578925757876187728287025114039857326317303278339398461867857347977086115056460092247241491050975844198985340426523543506642470867344489622920919379155783183864366137326681672448112894164616267464023,"Q":72606699845492920480612704269017934517828901158533144951361778561596098048496321620562777645080543517871509380887253792507925322852225292634412415947741395933210189313308555786353434448761010821796730061752574244665026173701424405889971335542944162644226805442113224166939344373950117364276725072698509734609}'

NSEC3=nsec1lz3rkp7cg450aghanh9fm5c7q0n5wnf44v96rk9yxxacmhctl4yss5trua
NPUB3=npub1pqxtrp3sj5mcdv98j9vjt52h50z4tjrqmvxclrlfa9338ljtds7s807vw4
PPM3='{"PaillierSK":{"N":22302891137538318866140275554704059499065593060776994072583478654610681630138400460250224640845668716727492375022364927532096983534053623810989506460988182509436585712593642753704507359843253324895534783943468592498651158004730831759123488224210505455417050399829065497007321760844163016434458970951456444038205661030691730307055866615335805384416717225368796562685233115606399584657275951092811116614754478719389205003897624375070783598459418646195499156783250473343640526329713357223980804548556385643612738889359823129893702062325072488204675707762969464073634752344984064154303388713486268191465240963668211771029,"LambdaN":11151445568769159433070137777352029749532796530388497036291739327305340815069200230125112320422834358363746187511182463766048491767026811905494753230494091254718292856296821376852253679921626662447767391971734296249325579002365415879561744112105252727708525199914532748503660880422081508217229485475728222018952859159138043540877046696781933783768153661216536923005990608494529257706437310525075558459543175062470484025864593169065394905539109171440900661842922494136841230412760966159480645034330857466908722526124483076165093981843999137221238332839106891102512938337142381769397782385879467737027788132421414358742,"PhiN":22302891137538318866140275554704059499065593060776994072583478654610681630138400460250224640845668716727492375022364927532096983534053623810989506460988182509436585712593642753704507359843253324895534783943468592498651158004730831759123488224210505455417050399829065497007321760844163016434458970951456444037905718318276087081754093393563867567536307322433073846011981216989058515412874621050151116919086350124940968051729186338130789811078218342881801323685844988273682460825521932318961290068661714933817445052248966152330187963687998274442476665678213782205025876674284763538795564771758935474055576264842828717484,"P":136241223459920182117901326751354658323810214990529785942501191991288332013249141089614894657675506378136557316489321380527178620132347347265263995611974450488449888234541154873262081478487875665903802158595156183124533557848483162718410156118218613461234174801399234296247250118936157632535483193681784834123,"Q":163701488955723043183871895020583158556599687945192930730750706626052737231152188953045105037992622216311679635679116656412815167248852956048433837485431034581508177269650270031757433001406795043891491678515700794438980540788591051043788885966537068407374700869300066319260573822791175084874181505143598219423},"NTildei":27527629627687821558388358623160125108867079861906179895744978296290898419029049149583134774965101921395377822355800885043484931162032663002576017153047576734305846985784729987678573516213211010806092907234506530686184897008269924047353513928446404278961268116591598886925997509892193287592651623438745204757113831399133841482574583450720361485260829284924433712129477999668814829958979977135512921553134548056428926907282306247213997440213612484831114017633123635785142673456410053955571328906697714654213748144725005238811964017927964363393225005872103128109948829035549381395668085590841702124721434299826782340509,"H1i":22762531716785630584214711596191182048545765272260825283513665064189347537364682662387535135268496973599602674402942982659015554140727969738451782344772804622988233735670199005846843359325726683827049981102952076451161179540071243316922657836241462688196810794161167599212703606479055144966187754066807731060642715807514448470406491136303496605612300451752611994205386430164482657312371165916229466279486505981215789358020372276385108689981285606056153794331893674721582470596093479154833057345136772339507063442632103118894666777519923585134385930733317301852473130088962247931563420200487042017312953327801872017660,"H2i":22443906596978373000410302099324917877093566383096533735985057606582910093299076761680927787303280465429088638331860669964167359428539817986682581804422911633832957826740853351519487356059909521227212124053528481093111850662708023726997869774139714831994482392778843468778211044238358326966004296553644838796809620133038954600279792973435016934702076752507362604614320442824299874241190096670776423184514089691472853909163381056272823112883593781677146105803134874413289540795741344877129737066608902524510873289211977941119467076454182333327243033102575860575863812803267240545028056443153258668390618068816780650960,"Alpha":15644696720786171223793801223364309715798630624451909992314570194881088605711477209630111099118669057227121685717860874794933917794727376884984816283038123447523113914060318681522913230901910079815188279344645618358993997496975785012639447054832475689775138520718527068091612218148928033600776983382482147715141673354102147333561330399759001837346282838177338394051374098659807067390098017612026819720751153237469854408794886751923875592736751970741333263031890250305966918958498039472840220902784412210123401192255227860030067656775430490343518950097338696023176973073863298534915152461888106797228432980589679100095,"Beta":4406821515311822829447783472616762019727129089137590463861694191232768202355368931718726876656482058621854684155582401896574320933484844113209647578290554595226646801988278906844636947841652736395811281541349421028154153219191964558090166697327027255481205828886771738583873295067770848247069565088549755008631320142366953617758255579543494582059700392703693529512266364098127814592781150197477929095342104618874787913141213204239190106006631018512576405446955236232100061383085489191803212912946227857433474601268441075625116456933178373883916340297259621813344787792573112038080369703317155002899181875790875217222,"P":85851457495436251943579819296527195322096246333256678451608384887926301628927797370919278726165996436130867789617043378533894212267226074697668410433842879268013306991575000027903785132372477606784080177014247135993684679939093728598330321726047657263596388019134881823084252787610009430343677270413923336141,"Q":80160635680387701453814749946641257981120751092978211270274048310762852933759110542870300840638101221659841453669425242363851121233836721351297470155804961948960102591169907497463803507081138708118698034520626703739141336757559544155210823131219319301291334813991409905437797220649789576165100329181337733011}'

ALL_NPUBS="$NPUB1,$NPUB2,$NPUB3"

sessionID=$("$BUILD_DIR/$BIN_NAME" random-seed)
sessionKey=$("$BUILD_DIR/$BIN_NAME" random-seed)
chainCode=$("$BUILD_DIR/$BIN_NAME" random-seed)

# Start the process directly - output will be visible in terminal
"$BUILD_DIR/$BIN_NAME" nostr-keygen "$NOSTR_RELAY" "$NSEC1" "$NPUB1" "$ALL_NPUBS" "$PPM1" "$sessionID" "$sessionKey" "$chainCode" "save" "somepass" "verbose" &
PIDS+=($!)

"$BUILD_DIR/$BIN_NAME" nostr-keygen "$NOSTR_RELAY" "$NSEC2" "$NPUB2" "$ALL_NPUBS" "$PPM2" "$sessionID" "$sessionKey" "$chainCode" "save" "somepass" "verbose" &
PIDS+=($!)

"$BUILD_DIR/$BIN_NAME" nostr-keygen "$NOSTR_RELAY" "$NSEC3" "$NPUB3" "$ALL_NPUBS" "$PPM3" "$sessionID" "$sessionKey" "$chainCode" "save" "somepass" "verbose" &
PIDS+=($!)

# Build the kill command for all PIDs
KILL_CMD=""
for pid in "${PIDS[@]}"; do
    if [ -n "$KILL_CMD" ]; then
        KILL_CMD="$KILL_CMD $pid"
    else
        KILL_CMD="$pid"
    fi
done

trap "echo 'Stopping processes...'; kill $KILL_CMD; exit" SIGINT SIGTERM

# Wait for all processes
echo "Waiting for all keygen processes to complete..."
wait

echo "All keygen processes completed!"